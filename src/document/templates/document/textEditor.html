{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Text Editor
{% endblock %}


{% block content %}

<div class="container">
    <form id="writingtool" method="POST" class="form-group">
        {% csrf_token %}
        {{ form.media }}
        {{ form | crispy }}
        <button type="submit" class="btn btn-success" onclick="removePrediction()">Save</button>
        <a class="btn btn-primary"  href="{% url 'profile' %}"> Return </a>
        <button class="btn btn-secondary" type="button" onclick="sendCompleteRequest()" id="complete"> Complete </button>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
    var lastSpace = false

    function getPredictionElement() {
        return CKEDITOR.instances.id_body.document.getById('prediction')
    }

    function getInputForPrediction(pressedKey = "") {
        // Return the input text to be consumed by the prediction model
        let inputText = CKEDITOR.instances.id_body.document.getBody().$.innerText.replace(/\n$/, "").replace(/\u200B/g,'').replace(/\u00a0/g, ' ')
        lastSpace ? inputText += ' ' + pressedKey : inputText += pressedKey
        let lines = inputText.split("\n")
        return lines[lines.length - 1]
    }

    function getInputForComplete() {
        // Return the input text to be consumed by the prediction model
        return CKEDITOR.instances.id_body.document.getBody().$.innerText.replace(/\n$/, "").replace(/\u200B/g,'')
    }

    function isPredictionValid(prediction_input) {
        return getInputForPrediction() === prediction_input
    }

    function insertPrediction(prediction) {
        let editor = CKEDITOR.instances.id_body
        let selection = editor.getSelection()
        if (selection == null) {
            return
        }
        let bookmarks = selection.createBookmarks(true);


        // Move cursor after bookmark span
        let node = editor.document.getById(bookmarks[0].startNode)
        let range = editor.createRange();
        range.setStartAfter(node);
        range.collapse(true);
        editor.getSelection().selectRanges([range]);
        editor.insertHtml("<span id='prediction' style='color: #AAA'>" + prediction + "</span>", 'unfiltered_html')

        selection.selectBookmarks(bookmarks);
    }

    function processResponse(response) {
        if (!isPredictionValid(response.input_text)) {
            return
        }
        insertPrediction(response.prediction)
    }

    function processResponseComplete(response) {
        insertPrediction(response.prediction)
    }

    function predictionMatchesKey(prediction, key) {
        // normalize
        if (prediction.length === 0) {
            return false
        }
        let normalizedPrediction = prediction[0].normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase()
        if (key === " ") {
            return prediction.startsWith(String.fromCharCode(160))

        }
        return prediction[0].toLowerCase().valueOf() === key.toLowerCase().valueOf()
    }

    function sendPredictionRequest(pressedKey = "") {
        $.ajax({
            url: "{% url 'prediction' %}",
            data: {
                input: getInputForPrediction(pressedKey)
            },
            dataType: 'json',
            success: function (response) {
                processResponse(response)
            },

        });
    }

    function acceptPrediction() {
        let editor = CKEDITOR.instances.id_body
        let currentPrediction = getPredictionElement()
        if (currentPrediction != null) {
            const currentPredictionText = currentPrediction.getText()
            editor.insertText(currentPredictionText)
            currentPrediction.remove()
        }
        lastSpace = false
        sendPredictionRequest()
    }

    function processKeyPress(event) {
        let key = event.data.$.key
        let currentPrediction = getPredictionElement()
        if (currentPrediction != null) {
            let currentPredictionText = currentPrediction.getText()
            if (predictionMatchesKey(currentPredictionText, key)) {
                currentPrediction.setText(currentPredictionText.substring(1))
                return
            }
            currentPrediction.remove()
        }
        sendPredictionRequest(key)
    }

    function printable(event) {
        const keycode = event.data.getKey();

        const valid =
            (keycode > 47 && keycode < 58) || // number keys
            (keycode === 32 || keycode === 13) || // spacebar & return key(s)
            (keycode > 64 && keycode < 91) || // letter keys
            (keycode > 95 && keycode < 112) || // numpad keys
            (keycode > 185 && keycode < 193) || // ;=,-./` (in order)
            (keycode > 218 && keycode < 223);   // [\]' (in order)

    return valid;

    }

    function sendCompleteRequest(){
        $("#complete").attr("disabled", true);
        removePrediction()
        $.ajax({
            url: "{% url 'complete_prediction' %}",
            data: {
                input: getInputForComplete()
            },
            dataType: 'json',
            success: function (response) {
                processResponseComplete(response)
                $("#complete").attr("disabled", false);
            },

        });
    }

    function updateLastChar(event) {
        lastSpace = event.data.getKey() === 32
    }

    function processKeyDown(event) {
        // Remove suggestion if del key is pressed.
        if (printable(event)){
            processKeyPress(event)
        }
        if (event.data.getKey() === 8) {
            removePrediction()
        }
        if (event.data.getKey() === 9) {
            if (!event.preventDefault) {
                event.data.preventDefault();
            }
            acceptPrediction()
        }
        updateLastChar(event)

    }

    function processKeyUp(event) {
        if (event.data.getKey() === 13) {
            removePrediction()
        }
    }

    function removePrediction(event) {
        let currentPrediction = getPredictionElement()
        if (currentPrediction != null) {
            currentPrediction.remove()
        }
    }

    CKEDITOR.on('instanceReady', function (e) {
        CKEDITOR.instances.id_body.document.on('keyup', processKeyUp)
        CKEDITOR.instances.id_body.document.on('keydown', processKeyDown)
        CKEDITOR.instances.id_body.document.on('click', removePrediction)
    })


</script>
{% endblock %}
